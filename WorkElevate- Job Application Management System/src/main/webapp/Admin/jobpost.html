<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title></title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/daisyui@4.12.23/dist/full.min.css" rel="stylesheet" type="text/css" />
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- font awesome -->
  <script src="https://kit.fontawesome.com/9ad568764d.js" crossorigin="anonymous"></script>
  <style>
    .loader {
      border-top-color: #3498db;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #customAlert {
      z-index: 1000;
    }
  </style>
</head>
<body class="bg-gray-100">

  <div class="flex min-h-screen ">
    <!-- Sidebar -->
    <div id="sidebar" class="fixed lg:static transform -translate-x-full lg:translate-x-0 transition-transform duration-300 bg-gradient-to-t from-cyan-500 to-blue-500 text-white w-80 min-h-screen flex flex-col p-4 font-bold z-50">
      <button class="btn block  focus:outline-none bg-gradient-to-r from-cyan-500 to-blue-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center w-1/5 ml-3 lg:hidden" id="close-sidebar">
        <i class="fa-solid fa-xmark "></i>
      </button>
      <ul class="menu text-xl">
        <li class="mb-2"><a href="./index.html" class="hover:bg-blue-600 rounded-md p-2"><i class="fa-solid fa-house"></i>Dashboard</a></li>
        <hr class="my-4 w-full border-white" />
        <li class="mb-2"><a class="hover:bg-blue-600 rounded-md p-2"  href="./candidate.html"><i class="fa-solid fa-person"></i>Candidates</a></li>
        <li class="mb-2"><a class="hover:bg-blue-600 rounded-md p-2" href="./jobpost.html"><i class="fa-solid fa-briefcase"></i>Job Posts</a></li>
        <li class="relative mb-2">
          <a href="#" class="rounded-md p-2 flex items-center" id="pagesDropdownButton">
            <i class="fa-solid fa-file-lines"></i> Pages
          </a>
          <ul class="absolute left-0 mt-10 w-full  text-white rounded-md  hidden" id="pagesDropdownMenu">
            
              <li><a href="./partner.html" class="block px-4 py-2 rounded-md">Upload Client Logo</a></li>
              <li><a href="./hrcontact.html" class="block px-4 py-2 rounded-md">Upload Contact</a></li>
              <!-- <li><a href="./businesscontact.html" class="block px-4 py-2 rounded-md">Buisness Contact</a></li> -->
          </ul>
      </li>
      </ul>
    </div>
    <!-- Main Content -->
    <div class="flex-1  w-full">
      <!-- Navbar -->
      <div class="navbar bg-white  p-4 shadow-md">
        <h1 class="text-xl text-black font-bold hidden sm:block">Job Posts</h1>
        <div class="flex-1">
          <!-- Sidebar Toggle Button for Mobile -->
          <button id="toggle-sidebar" class="btn block text-white focus:outline-none bg-gradient-to-r from-cyan-500 to-blue-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center lg:hidden w-1/5">
            <i class="fa-solid fa-bars"></i>
          </button>
        </div>
        <button id="logoutButton"  class="text-white font-medium h-10 flex px-2 py-1 justify-center items-center w-20 block text-white focus:outline-none bg-gradient-to-r from-cyan-500 to-blue-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center hover:bg-blue-600">Logout</button>
      </div>

      <!-- Page Content -->

      <div class="mt-5 mr-10 flex justify-end">
        <button class="block text-white focus:outline-none bg-gradient-to-r from-cyan-500 to-blue-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
            <a class="" href="./createpost.html">Create Job Post</a>
        </button>
      </div>

      <div class="p-6 w-full">
        <div class="bg-white shadow-md rounded-xl w-full max-w-full">
            
          <div class="p-3 rounded-t-xl flex justify-between items-center gap-4">
            <div class="flex flex-grow px-3 py-3 rounded-md border-2 border-gray-400 overflow-hidden max-w-sm">
              <i class="fa-solid fa-magnifying-glass"></i>
              <input
                  id="searchInput"
                  type="text"
                  placeholder="Search Something..."
                  class="w-full outline-none bg-transparent text-gray-600 text-sm ml-5"
              />
          </div>
       

<!-- Modal toggle -->
<button data-modal-target="crud-modal" data-modal-toggle="crud-modal" class="block text-white focus:outline-none bg-gradient-to-r from-cyan-500 to-blue-500 font-medium rounded-lg text-sm px-5 py-2.5 text-center" type="button">
    <i class="fa-solid fa-filter mr-3"></i>  Filter
  </button>
  
  <!-- Main modal -->
  <div id="crud-modal" class="hidden fixed top-[-20px] right-5 z-50 flex justify-end items-center w-full h-full">
      <div class="relative p-4 w-4/2 max-w-md max-h-full">
          <!-- Modal content -->
          <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
              <!-- Modal header -->
              <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
                  <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
                    Filters
                  </h3>
                  <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-toggle="crud-modal">
                    <i class="fa-solid fa-xmark "></i>
                      <span class="sr-only">Close modal</span>
                  </button>
              </div>
              <!-- Modal body -->
              <form class="p-4 md:p-5">
                <div class="mb-4">
                    <div class="">
                        <label for="categoryFilter" class="block mb-2 text-sm font-bold text-gray-900 dark:text-white">Job Category</label>
                        <select id="categoryFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">
                            <option selected="">select category</option>
                        </select>
                    </div>
                </div>
            
                <div class="mb-4">
                    <div class="">
                        <label for="experienceFilter" class="block mb-2 text-sm font-bold text-gray-900 dark:text-white">Experience</label>
                        <select id="experienceFilter" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-500 focus:border-primary-500 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white dark:focus:ring-primary-500 dark:focus:border-primary-500">
                            <option selected="">select experience</option>
                        </select>
                    </div>
                </div>
            
                <div class="flex justify-end gap-3">
                    <button id="resetBtn" class="text-gray-800 font-bold items-center bg-gray-400 hover:bg-gray-200 focus:ring-4 focus:outline-none focus:ring-gray-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-gray-200 dark:hover:bg-gray-200 dark:focus:ring-gray-200">Reset</button>
                    <button id="applyBtn" class="text-white font-bold items-center bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Apply</button>
                </div>
            </form>
          </div>
      </div>
  </div> 
  

        </div>
        <div class=" ml-10 items-center mt-5 flex-col sm:flex-row">
            <!-- Select Box (Left Side) -->
            <div class="flex gap-4 mb-4 sm:mb-0">
              <form class="max-w-sm">
                  <select id="countries" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500">
                      <option selected>5</option>
                      <option value="10">10</option>
                      <option value="20">20</option>
                      <option value="30">30</option>
                      <option value="40">40</option>
                  </select>
              </form>
              <p id="recordCount" class="mt-2 text-gray-500 font-medium">Showing 1 to 5 of 5 records</p>
          </div>
           
          </div>
           
          <hr class="my-4 mx-auto border-t-2 border-gray-300"/>
          <div class="p-4">
            <div class="">
                

<div class= "  w-full relative bg-white overflow-x-auto shadow-md sm:rounded-lg">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
      <input type="hidden" name="_csrf" id="csrfToken" />
        <thead class="text-xs  text-white uppercase bg-gray-50 dark:bg-gray-700 dark:text-white">
            <tr>
                <th scope="col" class="p-4">
                  #
                </th>
                <th scope="col" class="px-6 py-3">
                    Job Title
                </th>
                <th scope="col" class="px-6 py-3">
                    Job Description
                </th>
                <th scope="col" class="px-6 py-3">
                    Job Category
                </th>
                <th scope="col" class="px-6 py-3">
                  Education
                </th>
                <th scope="col" class="px-6 py-3">
                  Experience
              </th>

                <th scope="col" class="px-6 py-3">
                  Actions
                </th>
            </tr>
        </thead>
        <tbody id="jobTableBody">
         
        </tbody>
    </table>
</div>



            </div>
            
          </div>
          
        </div>
      </div>
      
    </div> 
  </div>
  <div id="loader" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div>
  </div>

  <!-- Custom Alert -->
  <div id="customAlert" class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center hidden">
    <div class="bg-white p-6 rounded-lg shadow-lg">
        <p id="alertMessage" class="text-lg"></p>
        <div class="flex justify-center mt-4">
            <button id="alertClose" class="bg-blue-500 text-white px-4 py-2 rounded">Close</button>
        </div>
    </div>
</div>

  <script src="./dashboard.js"></script>
<script src="./candidate.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script>
     document.addEventListener("DOMContentLoaded", function () {
        // Fetch CSRF token when the page loads
        fetch("/csrf-token", {
            credentials: 'include' // Ensure cookies are sent with the request
        })
        .then(response => response.json())
        .then(data => {
            // Set CSRF token in the hidden input field
            document.getElementById("csrfToken").value = data.token;
        })
        .catch(error => console.error("Error fetching CSRF token:", error));
    });

    async function checkSession() {
      try {
        const response = await axios.get('http://localhost:8080/api/v1/admin/check-session', {
          withCredentials: true // Include cookies in the request
        });

        if (!response.data.success) {
          // If session is invalid, redirect to login page
          window.location.href = '/admin-login.html';
        }
      } catch (error) {
        console.error('Session check failed:', error);
        window.location.href = '/admin-login.html';
      }
    }

    // Call the function when the page loads
    //checkSession();
    setInterval(checkSession, 600);

    document.getElementById('logoutButton').addEventListener('click', async function () {
    try {
      const _csrf = document.getElementById("csrfToken").value;
        const response = await fetch('http://localhost:8080/api/v1/admin/logout', {
            method: 'GET',
            headers: {
              'Content-Type': 'application/json',
                'X-CSRF-TOKEN': _csrf  // Add CSRF token to headers
            },
            credentials: 'include'
        });

        if (response.ok) {
         
            window.location.href = '/admin-login.html';
        } else {
           
        }
    } catch (error) {
        console.error('Error during logout:', error);
    }
    });

  let allJobs = []; // Store all jobs data globally

  // Fetch data from the API and populate the table
    async function fetchData() {
        try {
            const response = await fetch('http://localhost:8080/api/v1/job/jobpost-details'); // Replace with your API URL
            const data = await response.json();
            allJobs = data; // Store all jobs data
            populateTable(data); // Populate the table with all data
            populateDropdowns(data); // Populate dropdowns dynamically
        } catch (error) {
            console.error("Error fetching data:", error);
        }
    }

    function shortDes(data) {
      const words = data.split(' ').slice(0, 15);  // Split by space and slice the first 15 words
      return words.join(' ') + (words.length < data.split(' ').length ? '...' : '');  // Add ellipsis if there's more content
    }

    // Function to populate the table
    function populateTable(jobs) {
        const jobTableBody = document.getElementById('jobTableBody');
        jobTableBody.innerHTML = ''; // Clear existing table rows

        jobs.reverse().forEach((job, index) => {
        const row = document.createElement('tr');
        row.className = 'bg-white border-b dark:bg-gray-800 dark:border-gray-700 border-gray-200 ';

        row.innerHTML = `
            <td class="w-4 p-4">${index + 1}</td>
            <th scope="row" class="flex items-center px-6 py-4 font-medium text-white whitespace-nowrap dark:text-white">
                <div class="ps-3">
                <div class="font-normal text-white mb-1">${job.jobTitle}</div>
                </div>  
            </th>
            <td class="px-6 py-4">
                <div class="ps-3">
                <div class="font-normal text-white">${shortDes(job.jobDescription)}</div>
                </div>  
            </td>
            <td class="px-6 py-4">
                <div class="ps-3">
                <div class="font-normal text-white">${job.jobCategory}</div>
                </div>  
            </td>
            <td class="px-6 py-4">
                <div class="ps-3">
                <div class="font-normal text-white">${job.requiredQualification}</div>                    
                </div>  
            </td>
            <td class="px-6 py-4">
                <div class="ps-3">
                <div class="font-normal text-white">${job.experience}</div>
                </div>  
            </td>
            <td class="px-6 py-4 flex">
                <button class="rounded-md p-2">
                <a href="./updatejobpost.html?id=${job.id}">
                    <i class="fa-solid fa-pen text-xl"></i>
                </a>
                </button>
                <button class="rounded-md p-2 delete-button" data-job-id="${job.id}">
                <i class="fa-solid fa-trash text-xl text-red-500"></i>
                </button>
            </td>
        `;

        jobTableBody.appendChild(row);
      });

      updateRecordCount(jobs);

      // Add event listeners to delete buttons
        document.querySelectorAll('.delete-button').forEach(button => {
            button.addEventListener('click', (event) => {
            const jobId = event.currentTarget.getAttribute('data-job-id');
            deleteJob(jobId);
            });
        });
    }


  // Function to update the record count text
function updateRecordCount(jobs) {
    const recordCountText = document.getElementById('recordCount');
    const totalRecords = allJobs.length;
    const recordsDisplayed = jobs.length;
    recordCountText.textContent = `Showing 1 to ${recordsDisplayed} of ${totalRecords} records`;
}

// Function to apply filters or show a subset of records based on selection
document.getElementById('countries').addEventListener('change', function(e) {
    const recordsToShow = parseInt(e.target.value, 10); // Get the selected value (5, 10, etc.)
    const slicedCandidates = allJobs.slice(0, recordsToShow); // Slice the array based on the selection
    populateTable(slicedCandidates); // Populate the table with the sliced data
});


  // Function to populate the dropdowns dynamically
  function populateDropdowns(jobs) {
      const jobCategorySelect = document.getElementById('categoryFilter');
      const experienceSelect = document.getElementById('experienceFilter');

      // Populate job category dropdown
      const jobCategories = [...new Set(jobs.map(job => job.jobCategory))];
      jobCategories.forEach(category => {
          const option = document.createElement('option');
          option.value = category;
          option.textContent = category;
          jobCategorySelect.appendChild(option);
      });

      // Populate experience dropdown
      const experiences = [...new Set(jobs.map(job => job.experience))];
      experiences.forEach(exp => {
          const option = document.createElement('option');
          option.value = exp;
          option.textContent = exp;
          experienceSelect.appendChild(option);
      });
  }

  // Apply filter based on selected category and experience
  document.getElementById('applyBtn').addEventListener('click', function(e) {
    e.preventDefault();
      const selectedCategory = document.getElementById('categoryFilter').value;
      const selectedExperience = document.getElementById('experienceFilter').value;

      // Filter jobs based on selected category and experience
      const filteredJobs = allJobs.filter(job => {
          const categoryMatch = selectedCategory === '' || selectedCategory === 'select category' || job.jobCategory === selectedCategory;
          const experienceMatch = selectedExperience === '' || selectedExperience === 'select experience' || job.experience === selectedExperience;
          return categoryMatch && experienceMatch;
      });

      populateTable(filteredJobs); // Populate table with filtered data
  });

  // Reset the table to show all data
  document.getElementById('resetBtn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('categoryFilter').value = ''; // Reset the category dropdown
      document.getElementById('experienceFilter').value = ''; // Reset the experience dropdown
      populateTable(allJobs); // Populate table with all data
  });

   // Function to filter table data based on search input
   function filterTable(searchQuery) {
      const filteredJobs = allJobs.filter(job => {
          // Convert search query and job data to lowercase for case-insensitive search
          const query = searchQuery.toLowerCase();
          const jobTitle = job.jobTitle.toLowerCase();
          const jobDescription = job.jobDescription.toLowerCase();
          const jobCategory = job.jobCategory.toLowerCase(); 
          const experience = job.experience.toString().toLowerCase();
          const education = job.requiredQualification.toLowerCase();

          // Check if any field matches the search query
          return (
              jobTitle.includes(query) ||
              jobDescription.includes(query) ||
              jobCategory.includes(query) ||
              experience.includes(query) ||
              education.includes(query)
          );
      });

      // Populate the table with filtered data
      populateTable(filteredJobs);
  }

  // Add event listener to the search input
  document.getElementById('searchInput').addEventListener('input', function(e) {
      const searchQuery = e.target.value.trim(); // Get the search query
      filterTable(searchQuery); // Filter the table data
  });


  // Function to delete a job
  function deleteJob(jobId) {
    const _csrf = document.getElementById("csrfToken").value;
      fetch(`http://localhost:8080/api/v1/job/delete-jobpost/${jobId}`, {
          method: 'DELETE',
          headers: {
                'X-CSRF-TOKEN': _csrf,  // Correctly add CSRF token inside headers
          },
      })
      .then(response => response.json())
      .then(data => {
        // alert("deleted successfully")
        document.getElementById('loader').classList.add('hidden');
            // Show custom alert with error message
            document.getElementById('alertMessage').textContent = 'Deleted Successfully.';
            document.getElementById('customAlert').classList.remove('hidden');
          fetchData(); // Refresh the table after deletion
      })
      .catch(error => {
          // console.error('Error deleting job:', error);
      });
  }

  document.getElementById('alertClose').addEventListener('click', function () {
        document.getElementById('customAlert').classList.add('hidden');
    });

  // Fetch data when the page loads
  window.onload = fetchData;
</script>
</body>
</html>
